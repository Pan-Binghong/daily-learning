name: Notion åŒæ­¥ä¸ Hugo éƒ¨ç½²

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 æ‰§è¡Œï¼ˆUTC 01:00ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ master, main ]
    paths:
      - 'notion-config.yml'
      - 'notion-sync.py'
      - 'config.toml'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    # éœ€è¦å†™æƒé™æ¥æ¨é€ä»£ç 
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: true  # å¦‚æœä½¿ç”¨ Hugo ä¸»é¢˜å­æ¨¡å—
          fetch-depth: 0    # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          pip install -r requirements.txt

      - name: ğŸ“¥ ä» Notion åŒæ­¥å†…å®¹
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          python notion-sync.py

      - name: ğŸ“ æäº¤åŒæ­¥çš„å†…å®¹
        run: |
          git config --global user.name 'Notion Sync Bot'
          git config --global user.email 'action@github.com'

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain content/)" ]; then
            echo "ğŸ“ æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            git add content/
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Notion å†…å®¹ - $(date +'%Y-%m-%d %H:%M:%S')"

            # å…ˆæ‹‰å–è¿œç¨‹æ›´æ–°ï¼Œä½¿ç”¨ rebase é¿å…åˆå¹¶æäº¤
            echo "ğŸ“¥ æ‹‰å–è¿œç¨‹æ›´æ–°..."
            git fetch origin
            git rebase origin/${{ github.ref_name }} || {
              echo "âš ï¸  è‡ªåŠ¨ rebase å¤±è´¥ï¼Œä¸­æ­¢å¹¶é‡è¯•..."
              git rebase --abort
              # å¦‚æœ rebase å¤±è´¥ï¼Œç›´æ¥æ¨é€ï¼ˆä½¿ç”¨ force-with-lease æ›´å®‰å…¨ï¼‰
              git push --force-with-lease origin HEAD:${{ github.ref_name }}
              echo "âœ… ä½¿ç”¨ force-with-lease æ¨é€æˆåŠŸ"
              exit 0
            }

            # æ¨é€æ›´æ–°
            echo "ğŸ“¤ æ¨é€æ›´æ–°..."
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… å†…å®¹å·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸  æ²¡æœ‰å†…å®¹æ›´æ–°"
          fi

      - name: ğŸ—ï¸ è®¾ç½® Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true  # ä½¿ç”¨ Hugo Extended ç‰ˆæœ¬ï¼ˆæ”¯æŒ SCSSï¼‰

      - name: ğŸ”¨ æ„å»º Hugo ç«™ç‚¹
        run: hugo --minify

      - name: ğŸ“¤ éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          cname: your-domain.com  # å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸåï¼Œå–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹

      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "=========================================="
          echo "âœ¨ Notion åŒæ­¥å’Œ Hugo éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          echo "  - Hugo ç‰ˆæœ¬: $(hugo version)"
          echo "  - æ„å»ºæ—¶é—´: $(date)"
          echo "=========================================="

---
title: é…ç½®æœåŠ¡å™¨å…å¯†
date: '2024-11-29T01:08:00.000Z'
lastmod: '2025-02-11T02:07:00.000Z'
draft: false
tags:
- Linux
categories:
- DevOps
---

> ğŸ’¡ æœ¬æ–‡æ¡£æ˜¯æœåŠ¡å™¨å…å¯†é…ç½®çš„ç¬¬äºŒç‰ˆï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·é€šè¿‡ç”ŸæˆSSHå¯†é’¥å¯¹å’Œé…ç½®å…å¯†ç™»å½•ï¼Œç®€åŒ–è¿œç¨‹æœåŠ¡å™¨çš„ç®¡ç†ã€‚æœ¬æ–‡ä¹Ÿå°†ä»‹ç»å¦‚ä½•éªŒè¯å…å¯†é…ç½®æ˜¯å¦æˆåŠŸã€‚

## ä¸¤æœº

Aæœºå™¨è¾“å…¥ï¼š

```bash
ssh-keygen -t rsa -b 2048
```

```bash
ssh-copy-id ä½ çš„ç”¨æˆ·å@ä½ çš„IP
```

Bæœºå™¨è¾“å…¥ï¼š

```bash
vim /etc/ssh/sshd_config
```

```bash
PubkeyAuthentication yes
AuthorizedKeysFile     .ssh/authorized_keys
```

```bash
sudo systemctl restart sshd
```



---

## å¤šæœº

### 1. å‡†å¤‡IPæ–‡ä»¶

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªå­˜å‚¨ç›®æ ‡æœåŠ¡å™¨IPåœ°å€çš„æ–‡ä»¶ ip.txtã€‚

```shell
vim ip.txt
```

åœ¨ ip.txt æ–‡ä»¶ä¸­ï¼Œå†™å…¥éœ€è¦é…ç½®å…å¯†ç™»å½•çš„ç›®æ ‡æœºå™¨IPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ªIPã€‚ä¾‹å¦‚ï¼š

```plain text
192.168.1.10
192.168.1.20
192.168.1.32. åˆ›å»ºå¹¶è¿è¡Œé…ç½®è„šæœ¬
```

åˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶ set_key.shï¼Œç”¨äºç”ŸæˆSSHå¯†é’¥å¯¹å¹¶å°†å…¬é’¥å¤åˆ¶åˆ°ç›®æ ‡æœºå™¨ã€‚

```shell
vim set_key.sh
```

åœ¨è„šæœ¬ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

```shell
#!/bin/bash

# ç”ŸæˆSSHå¯†é’¥å¯¹ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
[ ! -f ~/.ssh/id_rsa.pub ] && ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa

# å°†å…¬é’¥å¤åˆ¶åˆ°æ¯å°ç›®æ ‡æœºå™¨
while read -r ip; do
  ssh-copy-id -i ~/.ssh/id_rsa.pub root@$ip
done < ip.txt
```

### 3. è®¾ç½®è„šæœ¬æƒé™å¹¶è¿è¡Œ

ä¸ºè„šæœ¬æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼Œå¹¶è¿è¡Œè„šæœ¬ã€‚

```shell
chmod +x set_key.sh
./set_key.sh
```

è¯¥è„šæœ¬ä¼šæ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨SSHå¯†é’¥å¯¹ï¼ˆid_rsaï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†é’¥å¯¹ã€‚ç„¶åï¼Œå®ƒä¼šå°†ç”Ÿæˆçš„å…¬é’¥ï¼ˆid_rsa.pubï¼‰å¤åˆ¶åˆ° ip.txt æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ‰€æœ‰ç›®æ ‡æœºå™¨ä¸Šã€‚

### 4. è‡ªåŠ¨åŒ–éªŒè¯ï¼ˆé€šè¿‡è„šæœ¬ï¼‰

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬è‡ªåŠ¨åŒ–éªŒè¯è¿‡ç¨‹ï¼š

```shell
#!/bin/bash

# è‡ªåŠ¨éªŒè¯æ¯å°ç›®æ ‡æœºå™¨çš„å…å¯†ç™»å½•æ˜¯å¦æˆåŠŸ
while read -r ip; do
  ssh -o BatchMode=yes -o ConnectTimeout=5 root@$ip "echo 'Connection successful'" &> /dev/null
  if [ $? -eq 0 ]; then
    echo "SSH login successful to $ip"
  else
    echo "SSH login failed to $ip"
  fi
done < ip.txt
```

è¿™ä¸ªéªŒè¯è„šæœ¬ä¼šå°è¯•æ— å¯†ç è¿æ¥æ¯å°ç›®æ ‡æœºå™¨ï¼Œå¹¶è¾“å‡ºè¿æ¥ç»“æœã€‚-o BatchMode=yes é€‰é¡¹ä½¿SSHä¸ä¼šæç¤ºè¾“å…¥å¯†ç ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼Œåˆ™è¾“å‡ºâ€œSSH login successfulâ€ï¼Œå¦åˆ™è¾“å‡ºâ€œSSH login failedâ€ã€‚

### æ³¨æ„äº‹é¡¹

- ç¡®ä¿ç›®æ ‡æœºå™¨å…è®¸rootç”¨æˆ·é€šè¿‡SSHè¿›è¡Œç™»å½•ï¼Œæˆ–è€…æ ¹æ®éœ€è¦ä¿®æ”¹è„šæœ¬ä¸­çš„ç”¨æˆ·åã€‚
- å¦‚æœæ˜¯érootç”¨æˆ·ï¼Œå¯ä»¥å°† root ä¿®æ”¹ä¸ºç›®æ ‡æœºå™¨ä¸Šçš„å…¶ä»–ç”¨æˆ·åã€‚
- å¦‚æœç›®æ ‡æœºå™¨çš„SSHç«¯å£ä¸æ˜¯é»˜è®¤çš„22ç«¯å£ï¼Œå¯ä»¥é€šè¿‡ ssh-copy-id -p PORT æŒ‡å®šç«¯å£ã€‚
- å¦‚æœé‡åˆ°â€œPermission deniedâ€é”™è¯¯ï¼Œæ£€æŸ¥ç›®æ ‡æœºå™¨çš„ ~/.ssh/authorized_keys æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿æ²¡æœ‰é˜»æ­¢SSHè®¿é—®çš„é…ç½®ï¼ˆå¦‚é˜²ç«å¢™è®¾ç½®ç­‰ï¼‰ã€‚
---




---
title: å¤§æ¨¡åž‹åˆ†å¸ƒå¼è®­ç»ƒ_æ•°æ®å¹¶è¡Œ
date: '2024-12-30T07:01:00.000Z'
lastmod: '2025-01-02T01:51:00.000Z'
draft: false
tags:
- Knowledge
categories:
- çŸ¥è¯†
---

> ðŸ’¡ è®°å½•å¹¶å­¦ä¹ å¤§æ¨¡åž‹åˆ†å¸ƒå¼è®­ç»ƒçš„æ–¹æ³•ä»¥åŠåŽŸç†ç­‰ã€‚

### æ•°æ®å¹¶è¡Œæ¦‚è¿°

æ•°æ®å¹¶è¡Œæ˜¯æœ€ç®€å•çš„å¹¶è¡Œè®­ç»ƒæ–¹æ³•ã€‚åœ¨æ•°æ®å¹¶è¡Œè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ•°æ®é›†è¢«åˆ†å‰²ä¸ºnä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†åˆ†é…åˆ°ä¸€ä¸ªGPUä¸Šã€‚ç›¸å½“äºŽæŒ‰ç…§:æ‰¹æ¬¡ç»´åº¦å¯¹è®­ç»ƒè¿›è¡Œå¹¶è¡ŒåŒ–ã€‚åŒæ—¶æ¯ä¸ªGPUéƒ½å°†æŒæœ‰ä¸€ä¸ªå®Œæ•´çš„æ¨¡åž‹å‰¯æœ¬ï¼Œå¹¶åœ¨åˆ†é…åŽçš„æ•°æ®ä¸Šè¿›è¡Œè®­ç»ƒã€‚

![](https://wdndev.github.io/llm_interview_note/04.%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/1.%E6%A6%82%E8%BF%B0/image/image_SZBLANWZcs.png)

---

### æ•°æ®å¹¶è¡Œï¼ˆPyTorch DPï¼‰



---

---

ç¼ºç‚¹:

- å•è¿›ç¨‹å¤šçº¿ç¨‹å¸¦æ¥çš„é—®é¢˜ï¼šDataParallelä½¿ç”¨å•è¿›ç¨‹å¤šçº¿ç¨‹è¿›è¡Œå®žçŽ°çš„ï¼Œæ–¹ä¾¿äº†ä¿¡æ¯çš„äº¤æ¢ï¼Œä½†å—å›°äºŽ GILï¼Œä¼šå¸¦æ¥æ€§èƒ½å¼€é”€ï¼Œé€Ÿåº¦å¾ˆæ…¢ã€‚è€Œä¸”ï¼Œåªèƒ½åœ¨å•å°æœåŠ¡å™¨ï¼ˆå•æœºå¤šå¡ï¼‰ä¸Šä½¿ç”¨ï¼ˆä¸æ”¯æŒåˆ†å¸ƒå¼ï¼‰ã€‚åŒæ—¶ï¼Œä¸èƒ½ä½¿ç”¨ Apex è¿›è¡Œæ··åˆç²¾åº¦è®­ç»ƒã€‚
- æ•ˆçŽ‡é—®é¢˜ï¼Œä¸»å¡æ€§èƒ½å’Œé€šä¿¡å¼€é”€å®¹æ˜“æˆä¸ºç“¶é¢ˆï¼ŒGPU åˆ©ç”¨çŽ‡é€šå¸¸å¾ˆä½Žï¼šæ•°æ®é›†éœ€è¦å…ˆæ‹·è´åˆ°ä¸»è¿›ç¨‹ï¼Œç„¶åŽå†åˆ†ç‰‡ï¼ˆsplitï¼‰åˆ°æ¯ä¸ªè®¾å¤‡ä¸Šï¼›æƒé‡å‚æ•°åªåœ¨ä¸»å¡ï¼ˆGPU0ï¼‰ä¸Šæ›´æ–°ï¼Œéœ€è¦æ¯æ¬¡è¿­ä»£å‰å‘æ‰€æœ‰è®¾å¤‡åšä¸€æ¬¡åŒæ­¥ï¼›æ¯æ¬¡è¿­ä»£çš„ç½‘ç»œè¾“å‡ºéœ€è¦èšé›†åˆ°ä¸»å¡ï¼ˆGPU0ï¼‰ä¸Šã€‚å› æ­¤ï¼Œé€šä¿¡å¾ˆå¿«æˆä¸ºä¸€ä¸ªç“¶é¢ˆã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™å°†å¯¼è‡´ä¸»å¡å’Œå…¶ä»–å¡ä¹‹é—´ï¼ŒGPUåˆ©ç”¨çŽ‡ä¸¥é‡ä¸å‡è¡¡ï¼ˆæ¯”å¦‚ï¼šä¸»å¡ä½¿ç”¨äº†10Gæ˜¾å­˜ï¼Œè€Œå…¶ä»–å¡åªä½¿ç”¨äº†2Gæ˜¾å­˜ï¼Œbatch sizeç¨å¾®è®¾ç½®å¤§ä¸€ç‚¹ä¸»å¡çš„æ˜¾å­˜å°±OOMäº†ï¼‰ã€‚
- ä¸æ”¯æŒæ¨¡åž‹å¹¶è¡Œï¼Œç”±äºŽå…¶æœ¬èº«çš„å±€é™æ€§ï¼Œæ²¡åŠžæ³•ä¸Žæ¨¡åž‹å¹¶è¡Œç»„åˆä½¿ç”¨ã€‚
---

### åˆ†å¸ƒå¼æ•°æ®å¹¶è¡ŒÂ ï¼ˆPyTorch DDPï¼‰

è®¡ç®—è¿‡ç¨‹:

- é¦–å…ˆå°† rank=0 è¿›ç¨‹ä¸­çš„æ¨¡åž‹å‚æ•°å¹¿æ’­åˆ°è¿›ç¨‹ç»„ä¸­çš„å…¶ä»–è¿›ç¨‹ï¼›
- ç„¶åŽï¼Œæ¯ä¸ª DDP è¿›ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªÂ local ReducerÂ æ¥è´Ÿè´£æ¢¯åº¦åŒæ­¥ã€‚
- åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹ä»Žç£ç›˜åŠ è½½ batch æ•°æ®ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’åˆ°å…¶ GPUã€‚æ¯ä¸ª GPU éƒ½æœ‰è‡ªå·±çš„å‰å‘è¿‡ç¨‹ï¼Œå®Œæˆå‰å‘ä¼ æ’­åŽï¼Œæ¢¯åº¦åœ¨å„ä¸ª GPUs é—´è¿›è¡Œ All-Reduceï¼Œæ¯ä¸ª GPU éƒ½æ”¶åˆ°å…¶ä»– GPU çš„æ¢¯åº¦ï¼Œä»Žè€Œå¯ä»¥ç‹¬è‡ªè¿›è¡Œåå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°ã€‚
- åŒæ—¶ï¼Œæ¯ä¸€å±‚çš„æ¢¯åº¦ä¸ä¾èµ–äºŽå‰ä¸€å±‚ï¼Œæ‰€ä»¥æ¢¯åº¦çš„ All-Reduce å’ŒåŽå‘è¿‡ç¨‹åŒæ—¶è®¡ç®—ï¼Œä»¥è¿›ä¸€æ­¥ç¼“è§£ç½‘ç»œç“¶é¢ˆã€‚
- åœ¨åŽå‘è¿‡ç¨‹çš„æœ€åŽï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¾—åˆ°äº†å¹³å‡æ¢¯åº¦ï¼Œè¿™æ ·å„ä¸ª GPU ä¸­çš„æ¨¡åž‹å‚æ•°ä¿æŒåŒæ­¥ ã€‚
---

### å…¸åž‹çš„æ•°æ®å¹¶è¡Œå®žçŽ°æ–¹æ³•:Pytorch DP/DDP

- å…³é”®ä»£ç 
- å•æœºæ•°æ®å¹¶è¡Œçš„Pytorchä»£ç å®žçŽ°
- å¤šæœº
---

### DPå’ŒDDPçš„åŒºåˆ«

1. DPæ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹ï¼Œåªå®žç”¨äºŽå•æœºã€‚DDPæ˜¯å¤šè¿›ç¨‹å®žçŽ°ï¼Œæ¯ä¸ªGPUè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”æ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯ç‹¬ç«‹çš„Pythonè§£é‡Šå™¨ï¼ŒDDPé¿å…äº†GILå¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚
1. æ›´æ–°å‚æ•°æ–¹å¼
1. DDPæ”¯æŒæ¨¡åž‹å¹¶è¡Œï¼ŒDPä¸æ”¯æŒã€‚
---

### è¡¥å……ZeROã€FSDP

æ¨¡åž‹çš„è®­ç»ƒè¿è¡Œå ç”¨çš„å†…å­˜åŒ…å«ï¼šæ¨¡åž‹æƒé‡ï¼Œæ¢¯åº¦å€¼ï¼Œæ¿€æ´»å€¼ï¼Œæ•°æ®(è¾“å…¥æ‰¹æ¬¡)å’Œä¼˜åŒ–å™¨çŠ¶æ€ã€‚ç”±äºŽDDPåœ¨æ¯ä¸ªGPUä¸Šéƒ½copyäº†ä¸€ä»½æ¨¡åž‹ï¼Œå› æ­¤DDPåªèƒ½é€‚ç”¨äºŽèƒ½å•å¡æ”¾ä¸‹æ¨¡åž‹æ—¶èµ·åˆ°ä½œç”¨ã€‚ä»¥ä¸‹æ˜¯ä¼˜åŒ–ç­–ç•¥:

- DeepSpeed(ZeRO)
- æ¿€æ´»æ£€æŸ¥ç‚¹
- å…¨åˆ†ç‰‡æ•°æ®å¹¶è¡Œ
---

> Reference












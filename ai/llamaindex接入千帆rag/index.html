<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LlamaIndex接入千帆RAG | 我的博客</title><meta name=keywords content="LLMs,RAG"><meta name=description content='记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.

导入大模型


1
2


from llama_index.llms.qianfan import Qianfan
access_key = ""secret_key = ""model_name = "ERNIE-4.0-8K-Latest"url = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro"llm = Qianfan(access_key, secret_key, model_name, url, context_window=8192)



model_name可在千帆平台查看, 如下图:



导入本地Embedding

下载Embedding模型



1
2


from modelscope import snapshot_download
model_dir = snapshot_download(&#39;Xorbits/bge-m3&#39;, cache_dir=&#39;/data/LLMs&#39;)



加载本地Embedding模型



1
2


from llama_index.embeddings.huggingface import HuggingFaceEmbedding
cache_folder = r"embed_model/m3e-large"embed_model = HuggingFaceEmbedding(cache_folder=cache_folder)



构建本地知识库


1
2


from llama_index.core import SimpleDirectoryReader, VectorStoreIndex
directory = "/data/documents" #文档路径vector_index = VectorStoreIndex.from_documents(documents)



构建查询引擎


1


query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm)



similarity_top_k可根据经验自行调整, 推荐设置3, 5.'><meta name=author content="Pan Binghong"><link rel=canonical href=https://Pan-Binghong.github.io/daily-learning/ai/llamaindex%E6%8E%A5%E5%85%A5%E5%8D%83%E5%B8%86rag/><link crossorigin=anonymous href=/daily-learning/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=https://Pan-Binghong.github.io/daily-learning/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://Pan-Binghong.github.io/daily-learning/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://Pan-Binghong.github.io/daily-learning/favicon-32x32.png><link rel=apple-touch-icon href=https://Pan-Binghong.github.io/daily-learning/apple-touch-icon.png><link rel=mask-icon href=https://Pan-Binghong.github.io/daily-learning/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://Pan-Binghong.github.io/daily-learning/ai/llamaindex%E6%8E%A5%E5%85%A5%E5%8D%83%E5%B8%86rag/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://Pan-Binghong.github.io/daily-learning/ai/llamaindex%E6%8E%A5%E5%85%A5%E5%8D%83%E5%B8%86rag/"><meta property="og:site_name" content="我的博客"><meta property="og:title" content="LlamaIndex接入千帆RAG"><meta property="og:description" content='记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.
导入大模型 1 2 from llama_index.llms.qianfan import Qianfan access_key = ""secret_key = ""model_name = "ERNIE-4.0-8K-Latest"url = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro"llm = Qianfan(access_key, secret_key, model_name, url, context_window=8192) model_name可在千帆平台查看, 如下图:
导入本地Embedding 下载Embedding模型 1 2 from modelscope import snapshot_download model_dir = snapshot_download(&#39;Xorbits/bge-m3&#39;, cache_dir=&#39;/data/LLMs&#39;) 加载本地Embedding模型 1 2 from llama_index.embeddings.huggingface import HuggingFaceEmbedding cache_folder = r"embed_model/m3e-large"embed_model = HuggingFaceEmbedding(cache_folder=cache_folder) 构建本地知识库 1 2 from llama_index.core import SimpleDirectoryReader, VectorStoreIndex directory = "/data/documents" #文档路径vector_index = VectorStoreIndex.from_documents(documents) 构建查询引擎 1 query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm) similarity_top_k可根据经验自行调整, 推荐设置3, 5.'><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="ai"><meta property="article:published_time" content="2024-10-29T01:52:00+00:00"><meta property="article:modified_time" content="2024-11-27T13:46:00+00:00"><meta property="article:tag" content="LLMs"><meta property="article:tag" content="RAG"><meta name=twitter:card content="summary"><meta name=twitter:title content="LlamaIndex接入千帆RAG"><meta name=twitter:description content='记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.

导入大模型


1
2


from llama_index.llms.qianfan import Qianfan
access_key = ""secret_key = ""model_name = "ERNIE-4.0-8K-Latest"url = "https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro"llm = Qianfan(access_key, secret_key, model_name, url, context_window=8192)



model_name可在千帆平台查看, 如下图:



导入本地Embedding

下载Embedding模型



1
2


from modelscope import snapshot_download
model_dir = snapshot_download(&#39;Xorbits/bge-m3&#39;, cache_dir=&#39;/data/LLMs&#39;)



加载本地Embedding模型



1
2


from llama_index.embeddings.huggingface import HuggingFaceEmbedding
cache_folder = r"embed_model/m3e-large"embed_model = HuggingFaceEmbedding(cache_folder=cache_folder)



构建本地知识库


1
2


from llama_index.core import SimpleDirectoryReader, VectorStoreIndex
directory = "/data/documents" #文档路径vector_index = VectorStoreIndex.from_documents(documents)



构建查询引擎


1


query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm)



similarity_top_k可根据经验自行调整, 推荐设置3, 5.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ais","item":"https://Pan-Binghong.github.io/daily-learning/ai/"},{"@type":"ListItem","position":2,"name":"LlamaIndex接入千帆RAG","item":"https://Pan-Binghong.github.io/daily-learning/ai/llamaindex%E6%8E%A5%E5%85%A5%E5%8D%83%E5%B8%86rag/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LlamaIndex接入千帆RAG","name":"LlamaIndex接入千帆RAG","description":"记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.\n导入大模型 1 2 from llama_index.llms.qianfan import Qianfan access_key = \u0026#34;\u0026#34;secret_key = \u0026#34;\u0026#34;model_name = \u0026#34;ERNIE-4.0-8K-Latest\u0026#34;url = \u0026#34;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro\u0026#34;llm = Qianfan(access_key, secret_key, model_name, url, context_window=8192) model_name可在千帆平台查看, 如下图:\n导入本地Embedding 下载Embedding模型 1 2 from modelscope import snapshot_download model_dir = snapshot_download(\u0026#39;Xorbits/bge-m3\u0026#39;, cache_dir=\u0026#39;/data/LLMs\u0026#39;) 加载本地Embedding模型 1 2 from llama_index.embeddings.huggingface import HuggingFaceEmbedding cache_folder = r\u0026#34;embed_model/m3e-large\u0026#34;embed_model = HuggingFaceEmbedding(cache_folder=cache_folder) 构建本地知识库 1 2 from llama_index.core import SimpleDirectoryReader, VectorStoreIndex directory = \u0026#34;/data/documents\u0026#34; #文档路径vector_index = VectorStoreIndex.from_documents(documents) 构建查询引擎 1 query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm) similarity_top_k可根据经验自行调整, 推荐设置3, 5.\n","keywords":["LLMs","RAG"],"articleBody":"记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.\n导入大模型 1 2 from llama_index.llms.qianfan import Qianfan access_key = \"\"secret_key = \"\"model_name = \"ERNIE-4.0-8K-Latest\"url = \"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro\"llm = Qianfan(access_key, secret_key, model_name, url, context_window=8192) model_name可在千帆平台查看, 如下图:\n导入本地Embedding 下载Embedding模型 1 2 from modelscope import snapshot_download model_dir = snapshot_download('Xorbits/bge-m3', cache_dir='/data/LLMs') 加载本地Embedding模型 1 2 from llama_index.embeddings.huggingface import HuggingFaceEmbedding cache_folder = r\"embed_model/m3e-large\"embed_model = HuggingFaceEmbedding(cache_folder=cache_folder) 构建本地知识库 1 2 from llama_index.core import SimpleDirectoryReader, VectorStoreIndex directory = \"/data/documents\" #文档路径vector_index = VectorStoreIndex.from_documents(documents) 构建查询引擎 1 query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm) similarity_top_k可根据经验自行调整, 推荐设置3, 5.\n构建RAG Agent 构建工具 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import os def get_tool(name, full_name, documents=None): if not os.path.exists(f\"./data/{name}\"): # build vector index vector_index = VectorStoreIndex.from_documents(documents) vector_index.storage_context.persist(persist_dir=f\"./data/{name}\") else: vector_index = load_index_from_storage( StorageContext.from_defaults(persist_dir=f\"./data/{name}\"), ) query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=llm) query_engine_tool = QueryEngineTool( query_engine=query_engine, metadata=ToolMetadata( name=name, description=( \"Provides information about Uber quarterly financials ending\" f\" {full_name}\" ), ), ) return query_engine_tool 设置Agent 1 2 3 from llama_index.core.agent import AgentRunner, ReActAgent agent = ReActAgent.from_tools( query_engine_tools, llm=agent_llm, verbose=True, max_iterations=20) 运行 1 response = agent.chat(\"您的问题\") 整体代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 from llama_index.core import Settings import os from llama_index.core import SimpleDirectoryReader, VectorStoreIndex from llama_index.llms.qianfan import Qianfan from llama_index.core.tools import QueryEngineTool, ToolMetadata from llama_index.embeddings.huggingface import HuggingFaceEmbedding # 初始化Qianfan模型class Rag: def __init__(self): self.access_key = \"\" self.secret_key = \"\" self.model_name = \"ERNIE-4.0-8K-Latest\" self.url = \"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro\" self.llm = Qianfan(self.access_key, self.secret_key, self.model_name, self.url, context_window=8192) self.cache_folder = r\"embed_model/m3e-large\" self.directory = r\"/data/documents\" # 数据目录路径 def get_tool(self, name, full_name, documents=None): embed_model = HuggingFaceEmbedding(cache_folder=self.cache_folder) Settings.embed_model = embed_model vector_index = VectorStoreIndex.from_documents(documents) persist_path = f\"{self.directory}/{name}\" if not os.path.exists(persist_path): vector_index.storage_context.persist(persist_dir=persist_path) query_engine = vector_index.as_query_engine(similarity_top_k=3, llm=self.llm) query_engine_tool = QueryEngineTool(query_engine=query_engine, metadata=ToolMetadata(name=name, description=f\"Provides information from document {full_name}\")) return query_engine_tool def parse_args(self): query_engine_tools = [] for filename in os.listdir(self.directory): if filename.endswith(\".txt\"): filepath = os.path.join(self.directory, filename) documents = SimpleDirectoryReader(input_files=[filepath]).load_data() tool_name = filename[:-4] # 去除'.txt'得到工具名称 tool = self.get_tool(tool_name, tool_name, documents=documents) query_engine_tools.append(tool) return query_engine_tools def query_engine(self, query): from llama_index.core.agent import ReActAgent tools = self.parse_args() agent = ReActAgent.from_tools(tools, llm=self.llm, verbose=True, max_iterations=20) response = agent.chat(query) return response # 创建 Rag 实例并执行查询if __name__ == \"__main__\": rag = Rag() print(rag.query_engine(query=\"问题\")) 参考链接\n","wordCount":"358","inLanguage":"en","datePublished":"2024-10-29T01:52:00Z","dateModified":"2024-11-27T13:46:00Z","author":{"@type":"Person","name":"Pan Binghong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://Pan-Binghong.github.io/daily-learning/ai/llamaindex%E6%8E%A5%E5%85%A5%E5%8D%83%E5%B8%86rag/"},"publisher":{"@type":"Organization","name":"我的博客","logo":{"@type":"ImageObject","url":"https://Pan-Binghong.github.io/daily-learning/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://Pan-Binghong.github.io/daily-learning/ accesskey=h title="我的博客 (Alt + H)">我的博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://Pan-Binghong.github.io/daily-learning/ title=首页><span>首页</span></a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/ai/ title=AI><span>AI</span></a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/knowledge/ title=知识库><span>知识库</span></a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/backend/ title=后端><span>后端</span></a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/devops/ title=DevOps><span>DevOps</span></a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/other/ title=其他><span>其他</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">LlamaIndex接入千帆RAG</h1><div class=post-meta><span title='2024-10-29 01:52:00 +0000 UTC'>October 29, 2024</span>&nbsp;·&nbsp;<span>Pan Binghong</span></div></header><div class=post-content><p>记录从使用Llama-index框架, 基于在线文心千帆大模型ERNIE-4.0, 构建实现本地知识检索.</p><p><img loading=lazy src="https://prod-files-secure.s3.us-west-2.amazonaws.com/fc187c04-cf34-444f-b5f2-bdcdfad76660/1f73f1b2-0e9d-4fdf-9a59-00189860a2f9/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4665YBT2FKV%2F20251106%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20251106T014209Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjENL%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBH1BYqB9llDZqTkjlTC12EN2OOplDjDLPZbya1lI0qdAiEA1cXQWj9ssPLjkILRI6x9cOxlnYOonKaVOdtNOHQUKikqiAQIm%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDEQozdIIzLVdxwrOjircAwYZizmqREBgHpn01neC3hAPhdVLvGkm3%2F487om2DZW0inSbc3fOKPBINQv9kO8s85FG9hzu%2FQ05iAFpVUvDWucBY1914J1IbO7EXhc%2F8jZ7zxWDSMQ5gwMSxyNoC5QO36Oapno8n4cGz0af3eB%2B0yeHSS4BdEia%2FQxfEyvY9z%2BeP%2BdjLeavFEr45CGffibSQVJApw7kWn6wYbm9PcUtzvc%2F1pjfu2ezkA1eodMJy0CJNsRSn%2BqZOfglqVQVYrVmDXaGLdLdEP4tJFzFQQ2jeT9ADvKl34tuJxI%2FWY63TR8Jp0%2F6Pd9BIBwNU7kv%2BW%2F6HH05R8Nswtkx3Y5uELyd%2F9wxlEiKtxBkvix29oxmN8v8tIqwM93%2B8ctgrg9D%2FkYzHqzt3ZxFV7HOuy3GhSTHjk3RmJs51ZLsLky5zAyOn%2BnliD75W0m8X%2BA6DZOL1FkJDOdYowJH4PJlc1F5a%2F0zNm%2BV3BlC8Xkl29j%2BQIboAFFttc2eYxs9cTh0pk%2F0dJ8S%2FvQ4oaryVV6rOAMIQKqazy7GcTgmTwLbNi0dn7kJ7EiFVvbFIGsNyz2fqfNevQSzyppXSaCeQywCblJpg4gswvuaHIgS9maIS%2BLEV5tBrP9GbtsPPVn9z56ryYxvMJHzr8gGOqUBU8q9wCO1zwItnDGiPC1AvJEZ4EGCUJWyKFDCD8Q%2B5dQL3kc%2BbpNNs%2B61s2qWQfpdMca0zR%2F0bm69bHXdkU9Wmgq0wi54Tdr%2Fa44pypoPMaXgNAbgf9bNM9Xd1C8JsgyAsqfNNb9tMvrkJJvHc6FXCYzSp%2FKaFejjOPwFRU9i6OoLofHC4BXwZ1BFCgOXipxYAN4WSAQ1a73fAgTtkoZ2BE%2B4WAQH&X-Amz-Signature=b46014ad7f39f93c45e9088079fd3a7d8b32eb64ae5bde29203ef9609b44607f&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject"></p><h3 id=导入大模型>导入大模型<a hidden class=anchor aria-hidden=true href=#导入大模型>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.llms.qianfan <span style=color:#f92672>import</span> Qianfan
</span></span><span style=display:flex><span>access_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>secret_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>model_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ERNIE-4.0-8K-Latest&#34;</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro&#34;</span>llm <span style=color:#f92672>=</span> Qianfan(access_key, secret_key, model_name, url, context_window<span style=color:#f92672>=</span><span style=color:#ae81ff>8192</span>)
</span></span></code></pre></td></tr></table></div></div><blockquote><p>model_name可在千帆平台查看, 如下图:</p></blockquote><p><img loading=lazy src="https://prod-files-secure.s3.us-west-2.amazonaws.com/fc187c04-cf34-444f-b5f2-bdcdfad76660/ec53fa42-9c7c-4b3b-b334-810c76b293ae/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4665YBT2FKV%2F20251106%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20251106T014209Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjENL%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIBH1BYqB9llDZqTkjlTC12EN2OOplDjDLPZbya1lI0qdAiEA1cXQWj9ssPLjkILRI6x9cOxlnYOonKaVOdtNOHQUKikqiAQIm%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDEQozdIIzLVdxwrOjircAwYZizmqREBgHpn01neC3hAPhdVLvGkm3%2F487om2DZW0inSbc3fOKPBINQv9kO8s85FG9hzu%2FQ05iAFpVUvDWucBY1914J1IbO7EXhc%2F8jZ7zxWDSMQ5gwMSxyNoC5QO36Oapno8n4cGz0af3eB%2B0yeHSS4BdEia%2FQxfEyvY9z%2BeP%2BdjLeavFEr45CGffibSQVJApw7kWn6wYbm9PcUtzvc%2F1pjfu2ezkA1eodMJy0CJNsRSn%2BqZOfglqVQVYrVmDXaGLdLdEP4tJFzFQQ2jeT9ADvKl34tuJxI%2FWY63TR8Jp0%2F6Pd9BIBwNU7kv%2BW%2F6HH05R8Nswtkx3Y5uELyd%2F9wxlEiKtxBkvix29oxmN8v8tIqwM93%2B8ctgrg9D%2FkYzHqzt3ZxFV7HOuy3GhSTHjk3RmJs51ZLsLky5zAyOn%2BnliD75W0m8X%2BA6DZOL1FkJDOdYowJH4PJlc1F5a%2F0zNm%2BV3BlC8Xkl29j%2BQIboAFFttc2eYxs9cTh0pk%2F0dJ8S%2FvQ4oaryVV6rOAMIQKqazy7GcTgmTwLbNi0dn7kJ7EiFVvbFIGsNyz2fqfNevQSzyppXSaCeQywCblJpg4gswvuaHIgS9maIS%2BLEV5tBrP9GbtsPPVn9z56ryYxvMJHzr8gGOqUBU8q9wCO1zwItnDGiPC1AvJEZ4EGCUJWyKFDCD8Q%2B5dQL3kc%2BbpNNs%2B61s2qWQfpdMca0zR%2F0bm69bHXdkU9Wmgq0wi54Tdr%2Fa44pypoPMaXgNAbgf9bNM9Xd1C8JsgyAsqfNNb9tMvrkJJvHc6FXCYzSp%2FKaFejjOPwFRU9i6OoLofHC4BXwZ1BFCgOXipxYAN4WSAQ1a73fAgTtkoZ2BE%2B4WAQH&X-Amz-Signature=469664206c31b6bdf504140b5721ff166c5387bdd7a7b5e1fa91e2f07b5dd2ce&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject"></p><hr><h3 id=导入本地embedding>导入本地Embedding<a hidden class=anchor aria-hidden=true href=#导入本地embedding>#</a></h3><ul><li>下载Embedding模型</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> modelscope <span style=color:#f92672>import</span> snapshot_download
</span></span><span style=display:flex><span>model_dir <span style=color:#f92672>=</span> snapshot_download(<span style=color:#e6db74>&#39;Xorbits/bge-m3&#39;</span>, cache_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/data/LLMs&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>加载本地Embedding模型</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.embeddings.huggingface <span style=color:#f92672>import</span> HuggingFaceEmbedding
</span></span><span style=display:flex><span>cache_folder <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;embed_model/m3e-large&#34;</span>embed_model <span style=color:#f92672>=</span> HuggingFaceEmbedding(cache_folder<span style=color:#f92672>=</span>cache_folder)
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=构建本地知识库>构建本地知识库<a hidden class=anchor aria-hidden=true href=#构建本地知识库>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.core <span style=color:#f92672>import</span> SimpleDirectoryReader, VectorStoreIndex
</span></span><span style=display:flex><span>directory <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/data/documents&#34;</span> <span style=color:#75715e>#文档路径vector_index = VectorStoreIndex.from_documents(documents)</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=构建查询引擎>构建查询引擎<a hidden class=anchor aria-hidden=true href=#构建查询引擎>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>query_engine <span style=color:#f92672>=</span> vector_index<span style=color:#f92672>.</span>as_query_engine(similarity_top_k<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, llm<span style=color:#f92672>=</span>llm)
</span></span></code></pre></td></tr></table></div></div><blockquote><p>similarity_top_k可根据经验自行调整, 推荐设置3, 5.</p></blockquote><hr><h3 id=构建rag-agent>构建RAG Agent<a hidden class=anchor aria-hidden=true href=#构建rag-agent>#</a></h3><ul><li>构建工具</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_tool</span>(name, full_name, documents<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;./data/</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#75715e># build vector index        vector_index = VectorStoreIndex.from_documents(documents)</span>
</span></span><span style=display:flex><span>        vector_index<span style=color:#f92672>.</span>storage_context<span style=color:#f92672>.</span>persist(persist_dir<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;./data/</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        vector_index <span style=color:#f92672>=</span> load_index_from_storage(
</span></span><span style=display:flex><span>            StorageContext<span style=color:#f92672>.</span>from_defaults(persist_dir<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;./data/</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    query_engine <span style=color:#f92672>=</span> vector_index<span style=color:#f92672>.</span>as_query_engine(similarity_top_k<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, llm<span style=color:#f92672>=</span>llm)
</span></span><span style=display:flex><span>    query_engine_tool <span style=color:#f92672>=</span> QueryEngineTool(
</span></span><span style=display:flex><span>        query_engine<span style=color:#f92672>=</span>query_engine,
</span></span><span style=display:flex><span>        metadata<span style=color:#f92672>=</span>ToolMetadata(
</span></span><span style=display:flex><span>            name<span style=color:#f92672>=</span>name,
</span></span><span style=display:flex><span>            description<span style=color:#f92672>=</span>(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;Provides information about Uber quarterly financials ending&#34;</span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34; </span><span style=color:#e6db74>{</span>full_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>            ),
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> query_engine_tool
</span></span></code></pre></td></tr></table></div></div><ul><li>设置Agent</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.core.agent <span style=color:#f92672>import</span> AgentRunner, ReActAgent
</span></span><span style=display:flex><span>agent <span style=color:#f92672>=</span> ReActAgent<span style=color:#f92672>.</span>from_tools(
</span></span><span style=display:flex><span>    query_engine_tools, llm<span style=color:#f92672>=</span>agent_llm, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, max_iterations<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>运行</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>response <span style=color:#f92672>=</span> agent<span style=color:#f92672>.</span>chat(<span style=color:#e6db74>&#34;您的问题&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=整体代码>整体代码<a hidden class=anchor aria-hidden=true href=#整体代码>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.core <span style=color:#f92672>import</span> Settings
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.core <span style=color:#f92672>import</span> SimpleDirectoryReader, VectorStoreIndex
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.llms.qianfan <span style=color:#f92672>import</span> Qianfan
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.core.tools <span style=color:#f92672>import</span> QueryEngineTool, ToolMetadata
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> llama_index.embeddings.huggingface <span style=color:#f92672>import</span> HuggingFaceEmbedding
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化Qianfan模型class Rag:</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>access_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>        self<span style=color:#f92672>.</span>secret_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>        self<span style=color:#f92672>.</span>model_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ERNIE-4.0-8K-Latest&#34;</span>        self<span style=color:#f92672>.</span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro&#34;</span>        self<span style=color:#f92672>.</span>llm <span style=color:#f92672>=</span> Qianfan(self<span style=color:#f92672>.</span>access_key, self<span style=color:#f92672>.</span>secret_key, self<span style=color:#f92672>.</span>model_name, self<span style=color:#f92672>.</span>url, context_window<span style=color:#f92672>=</span><span style=color:#ae81ff>8192</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>cache_folder <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;embed_model/m3e-large&#34;</span>        self<span style=color:#f92672>.</span>directory <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;/data/documents&#34;</span>  <span style=color:#75715e># 数据目录路径    def get_tool(self, name, full_name, documents=None):</span>
</span></span><span style=display:flex><span>        embed_model <span style=color:#f92672>=</span> HuggingFaceEmbedding(cache_folder<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>cache_folder)
</span></span><span style=display:flex><span>        Settings<span style=color:#f92672>.</span>embed_model <span style=color:#f92672>=</span> embed_model
</span></span><span style=display:flex><span>        vector_index <span style=color:#f92672>=</span> VectorStoreIndex<span style=color:#f92672>.</span>from_documents(documents)
</span></span><span style=display:flex><span>        persist_path <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>self<span style=color:#f92672>.</span>directory<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(persist_path):
</span></span><span style=display:flex><span>            vector_index<span style=color:#f92672>.</span>storage_context<span style=color:#f92672>.</span>persist(persist_dir<span style=color:#f92672>=</span>persist_path)
</span></span><span style=display:flex><span>        query_engine <span style=color:#f92672>=</span> vector_index<span style=color:#f92672>.</span>as_query_engine(similarity_top_k<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>, llm<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>llm)
</span></span><span style=display:flex><span>        query_engine_tool <span style=color:#f92672>=</span> QueryEngineTool(query_engine<span style=color:#f92672>=</span>query_engine, metadata<span style=color:#f92672>=</span>ToolMetadata(name<span style=color:#f92672>=</span>name, description<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Provides information from document </span><span style=color:#e6db74>{</span>full_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> query_engine_tool
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>parse_args</span>(self):
</span></span><span style=display:flex><span>        query_engine_tools <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> filename <span style=color:#f92672>in</span> os<span style=color:#f92672>.</span>listdir(self<span style=color:#f92672>.</span>directory):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> filename<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#34;.txt&#34;</span>):
</span></span><span style=display:flex><span>                filepath <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(self<span style=color:#f92672>.</span>directory, filename)
</span></span><span style=display:flex><span>                documents <span style=color:#f92672>=</span> SimpleDirectoryReader(input_files<span style=color:#f92672>=</span>[filepath])<span style=color:#f92672>.</span>load_data()
</span></span><span style=display:flex><span>                tool_name <span style=color:#f92672>=</span> filename[:<span style=color:#f92672>-</span><span style=color:#ae81ff>4</span>]  <span style=color:#75715e># 去除&#39;.txt&#39;得到工具名称                tool = self.get_tool(tool_name, tool_name, documents=documents)</span>
</span></span><span style=display:flex><span>                query_engine_tools<span style=color:#f92672>.</span>append(tool)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> query_engine_tools
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>query_engine</span>(self, query):
</span></span><span style=display:flex><span>        <span style=color:#f92672>from</span> llama_index.core.agent <span style=color:#f92672>import</span> ReActAgent
</span></span><span style=display:flex><span>        tools <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>parse_args()
</span></span><span style=display:flex><span>        agent <span style=color:#f92672>=</span> ReActAgent<span style=color:#f92672>.</span>from_tools(tools, llm<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>llm, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, max_iterations<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> agent<span style=color:#f92672>.</span>chat(query)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span><span style=color:#75715e># 创建 Rag 实例并执行查询if __name__ == &#34;__main__&#34;:</span>
</span></span><span style=display:flex><span>    rag <span style=color:#f92672>=</span> Rag()
</span></span><span style=display:flex><span>    print(rag<span style=color:#f92672>.</span>query_engine(query<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;问题&#34;</span>))
</span></span></code></pre></td></tr></table></div></div><blockquote><p>参考链接</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://Pan-Binghong.github.io/daily-learning/tags/llms/>LLMs</a></li><li><a href=https://Pan-Binghong.github.io/daily-learning/tags/rag/>RAG</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://Pan-Binghong.github.io/daily-learning/>我的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>